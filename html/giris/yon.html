<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Yön Tuşu Ustası - Büyük Final</title>
    <style>
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #0d0d1a; font-family: sans-serif; color: white; overflow: hidden; }
        canvas { border: 4px solid #3498db; background-color: #16213e; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        .ui { margin-bottom: 10px; text-align: center; }
        .level-info { font-size: 32px; font-weight: bold; color: #00d2ff; }
        #finalMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: bold;
            color: #f1c40f; /* Altın sarısı */
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.7);
            z-index: 10;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none; /* Üzerine tıklanmasını engelle */
        }
        #finalMessage.show {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="ui">
        <div class="level-info" id="levelDisplay">SEVİYE: 1</div>
        <p>Hedefe ulaşınca ne olacağını gör!</p>
    </div>

    <canvas id="gameCanvas" width="600" height="400"></canvas>
    <div id="finalMessage">TEBRİKLER! OYUN BİTTİ!</div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const levelDisplay = document.getElementById("levelDisplay");
        const finalMessageDiv = document.getElementById("finalMessage");

        let currentLevel = 1;
        let keys = {};
        const player = { x: 20, y: 20, size: 16, speed: 4 };
        let goal = { x: 550, y: 350, size: 30, scale: 1 };
        
        let particles = [];
        let gameEnded = false; // Oyunun bitip bitmediğini kontrol eden bayrak

        const monsters = [
            { x: 245, y: 50, size: 25, speedY: 4, direction: 1, activeIn: [4, 5] },
            { x: 415, y: 300, size: 25, speedY: 5, direction: -1, activeIn: [5] }
        ];

        const levels = {
            1: [ { x: 200, y: 0, w: 25, h: 300 }, { x: 400, y: 100, w: 25, h: 300 } ],
            2: [ { x: 150, y: 0, w: 25, h: 250 }, { x: 300, y: 150, w: 25, h: 250 }, { x: 450, y: 0, w: 25, h: 250 } ],
            3: [ { x: 120, y: 100, w: 20, h: 300 }, { x: 240, y: 0, w: 20, h: 300 }, { x: 360, y: 100, w: 20, h: 300 }, { x: 480, y: 0, w: 20, h: 300 } ],
            4: [ 
                { x: 150, y: 0, w: 25, h: 150 }, { x: 150, y: 250, w: 25, h: 150 }, 
                { x: 330, y: 0, w: 25, h: 200 }, { x: 330, y: 300, w: 25, h: 100 }, 
                { x: 480, y: 100, w: 25, h: 300 } 
            ],
            5: [ 
                { x: 100, y: 0, w: 20, h: 180 }, { x: 100, y: 280, w: 20, h: 120 }, 
                { x: 220, y: 120, w: 20, h: 280 }, 
                { x: 360, y: 0, w: 20, h: 220 }, { x: 360, y: 320, w: 20, h: 80 }, 
                { x: 480, y: 150, w: 20, h: 250 } 
            ]
        };

        window.addEventListener("keydown", (e) => { keys[e.code] = true; });
        window.addEventListener("keyup", (e) => { keys[e.code] = false; });

        function createParticles(x, y, color, count = 15) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    life: 25, color: color
                });
            }
        }

        function resetPlayer(collisionX, collisionY) {
            if (collisionX !== undefined) createParticles(collisionX, collisionY, "#ff6b6b"); // Çarpışma kıvılcımları
            player.x = 20; player.y = 20; keys = {};
        }

        function checkCollision(r1, r2) {
            const r2Size = r2.size * (r2.scale || 1);
            return r1.x < r2.x + (r2.w || r2Size) && r1.x + r1.size > r2.x &&
                   r1.y < r2.y + (r2.h || r2Size) && r1.y + r1.size > r2.y;
        }

        function handleGoal() {
            createParticles(goal.x + goal.size/2, goal.y + goal.size/2, "#2ecc71", 30); // Hedef konfetileri
            goal.scale = 1.5;
            
            setTimeout(() => {
                goal.scale = 1;
                if (currentLevel < 5) {
                    currentLevel++;
                    levelDisplay.innerText = "SEVİYE: " + currentLevel;
                    resetPlayer();
                } else {
                    // OYUN BİTTİ!
                    gameEnded = true;
                    finalMessageDiv.classList.add("show");
                    // Konfeti patlaması
                    for(let i = 0; i < 100; i++) {
                        const randomColor = Math.random() > 0.5 ? "#2ecc71" : "#f1c40f"; // Yeşil ve Sarı konfeti
                        createParticles(canvas.width / 2, canvas.height / 2, randomColor, 1); // Ekranın ortasından
                    }
                    setTimeout(() => {
                        // Birkaç saniye sonra oyunu sıfırla
                        finalMessageDiv.classList.remove("show");
                        gameEnded = false;
                        currentLevel = 1;
                        levelDisplay.innerText = "SEVİYE: 1";
                        resetPlayer();
                    }, 4000); // 4 saniye sonra sıfırla
                }
            }, 300);
        }

        function update() {
            if (gameEnded) { // Oyun bittiyse oyuncu hareket edemesin
                particles.forEach((p, index) => { // Konfetiler düşmeye devam etsin
                    p.x += p.vx; p.y += p.vy; p.life--;
                    if (p.life <= 0) particles.splice(index, 1);
                });
                return; 
            }

            if (keys["ArrowUp"]) player.y -= player.speed;
            if (keys["ArrowDown"]) player.y += player.speed;
            if (keys["ArrowLeft"]) player.x -= player.speed;
            if (keys["ArrowRight"]) player.x += player.speed;

            if (player.x < 0 || player.x + player.size > canvas.width || player.y < 0 || player.y + player.size > canvas.height) {
                resetPlayer(player.x + player.size/2, player.y + player.size/2);
            }

            levels[currentLevel].forEach(obs => {
                if (checkCollision(player, obs)) resetPlayer(player.x + player.size/2, player.y + player.size/2);
            });

            monsters.forEach(m => {
                if (m.activeIn.includes(currentLevel)) {
                    m.y += m.speedY * m.direction;
                    if (m.y <= 0 || m.y + m.size >= canvas.height) m.direction *= -1;
                    if (checkCollision(player, m)) resetPlayer(player.x + player.size/2, player.y + player.size/2);
                }
            });

            particles.forEach((p, index) => {
                p.x += p.vx; p.y += p.vy; p.life--;
                if (p.life <= 0) particles.splice(index, 1);
            });

            if (checkCollision(player, goal)) {
                if (goal.scale === 1) handleGoal();
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = "#2ecc71"; // Hedef
            const currentGoalSize = goal.size * goal.scale;
            const offset = (currentGoalSize - goal.size) / 2;
            ctx.fillRect(goal.x - offset, goal.y - offset, currentGoalSize, currentGoalSize);

            ctx.fillStyle = "#e94560"; // Engeller
            levels[currentLevel].forEach(obs => ctx.fillRect(obs.x, obs.y, obs.w, obs.h));

            monsters.forEach(m => { // Canavarlar
                if (m.activeIn.includes(currentLevel)) {
                    ctx.fillStyle = "#f1c40f";
                    ctx.fillRect(m.x, m.y, m.size, m.size);
                }
            });

            particles.forEach(p => { // Parçacıklar
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
            });

            if (!gameEnded) { // Oyun bitince oyuncuyu çizme
                ctx.fillStyle = "#00d2ff"; // Oyuncu
                ctx.fillRect(player.x, player.y, player.size, player.size);
            }
            
            requestAnimationFrame(draw);
        }

        setInterval(update, 1000/60);
        draw();
    </script>
</body>
</html>